## 유튜브 설계
> 유튜브, 넷플릭스 같은 비디오 플랫폼을 설계해보자. 

### 1️⃣ 문제 이해 및 설계 범위 확정

유튜브는 단순히 비디오를 보는 것 말고도 많은 기능들이 있다. 비디오에 좋아요와 댓글을 남기고, 재생목록에 저장하고, 채널을 검색하여 구독하고, 비디오를 공유할 수도 있다. 


#### 설계 범위 

- 빠른 비디오 업로드
- 원활한 비디오 재생
- 재생 품질 선택 가능
- 낮은 인프라 비용
- 높은 가용성, 규모확장성, 안정성
- 지원 클라이언트: 모바일 앱, 웹 브라우저, 스마트 TV


#### 개략적 규모 추정

- 5 million DAU
- 한 사용자가 하루 평균 5개의 비디오 시청
- 10%의 사용자가 하루에 1 비디오 업로드
- 비디오 평균 크기 300MB
- 비디오 저장을 위해 매일 새로 요구되는 저장 용량 
  - 5백만 * 10% * 300MB = 150TB
- CDN 비용
  - Amazon CloudFront를 CDN 솔루션으로 사용하겠다
  - 100% 트래픽이 한국에서 발생한다면 단순히 계산했을 때 1GB 당 $0.06의 요금이 발생
  - 따라서 매일 발생하는 요금은 5백만 * 5비디오 * 0.3GB * $0.06 = **$450,000**
  - CDN 서비스가 결코 싸지 않다... 한국은 미국보다 3배나 더 비싸다...


### 2️⃣ 개략적 설계안 제시 및 동의 구하기

기존 클라우드 서비스를 활용하는 이유

- 시스템 면접 설계가 모든 것을 밑바닥부터 만들라는 의도가 아님
- 주어진 시간 안에 적절한 기술을 골라 설계를 마치는 것이 중요
- 규모 확장이 쉬운 BLOB 저장소나 CDN를 만드는 것이 복잡하고 비용이 많이 든다
  - 넷플릭스는 Amazon, 페이스북은 Akamai의 CDN을 이용


#### 비디오 업로드 절차

비디오 업로드 처리는 다음 두 프로세스가 병렬적으로 수행된다.

    1. 비디오 업로드
    2. 비디오 메타데이터 갱신.(메타데이터: 비디오 URL, 크기, 해상도, 포맷, 사용자 정보)


#### 비디오 스트리밍 절차

스트리밍이란 클라이언트 장치에서 원격 저장소에 있는 비디오에 대한 비디오 스트림을 지속적으로 전송받아 영상을 재생하는 것.
비디오는 CDN에서 바로 스트리밍된다고 가정해서 간단하게 설계한다. 


### 3️⃣ 상세 설계

#### 비디오 트랜스코딩 

- 트랜스코딩 = 인코딩 
- 가공 전 raw video는 용량이 크다.
- 호환성을 위해 하나의 비디오를 여러 포맷으로 인코딩한다.
- 사용자의 네트워크 대역폭을 고려하여 저화질/고화질 비디오를 끊김없이 보내야 한다. 
- 모바일 환경을 위해 화질을 자동/수동으로 변경할 수 있게 한다. 

인코딩 포맷 구성 

- 컨테이너: 비디오 파일, 오디오, 메타데이터를 담는 바구니. 컨테이너 포맷은 .mov, .mp4 같은 파일 확장자를 보면 알 수 있다. 
- 코덱: 비디오 화질은 보존하면서 파일 크기를 줄일 목적으로 고안된 압축 및 압축 해제 알고리즘. H.264, VP9, HEVC가 많이 사용된다. 


#### 유향 비순환 그래프(DAG) 모델

콘텐츠 창작자의 비디오 프로세싱 요구사항을 만족하기 위해 클라이언트에서 실행할 작업을 손수 정의할 수 있도록 DAG 프로그래밍 모델을 도입한다. 


#### 비디오 트랜스코딩 아키텍처

비디오 트랜스코딩 아키텍처 설계 과정이 넘 길어서 짧게 요약해 보자면

```text
긴 프로세스를 작은 단계로 나누고 모듈로 만들어서 결합을 느슨하게 만들어라. 유연하고 확장 가능한 설계를 해라.  
```

#### 시스템 최적화 

속도 최적화

- **비디오 병렬 업로드**: 하나의 비디오를 작은 GOP로 분할하여 병렬적으로 업로드하면 일부가 실패해도 빠르게 업로드를 재개할 수 있다. 이 작업을 단말이 수행해주면 작업속도를 높일 수 있다. 
- **업로드 센터를 사용자 근거리에 지정**: 진짜 물리적으로 가까운 지역의 업로드 서버로 업로드하게 한다. 
- **모든 절차 병렬화**: 낮은 응답지연을 위해 느슨하게 결합된 시스템을 만들어 병렬성을 높인다. 각 단계 사이에 메시지 큐를 도입하면 이전 모듈의 작업이 끝나기를 기다릴 필요 없이 메시지 큐에 보관 이벤트 각각을 병렬적으로 처리할 수 있게 된다. 

안정성 최적화

- **미리 사인된 업로드 URL**: 허가받은(authrized) 사용자만 올바른 장소에서 비디오를 업로드할 수 있도록 pre-signed url 을 이용한다. pre-signed URL은 Amazon S3의 용어로 해당 URL이 가리키는 객체에 대한 접근 권한이 주어진 상태이다.  
- **비디오 보호**: 디지털 저작권 관리 시스템, AES 암호화, 워터마크 등으로 비디오 원본에 대한 도난을 방지한다.

비용 최적화

1. 인기 비디오는 CDN을 통해 스트리밍하고 나머지 비디오는 비디오 서버를 통해 스트리밍 
2. 인기 없는 비디오, 짧은 비디오는 재생 시점에 인코딩
3. 특정 지역에서 인기있는 비디오는 그 지역 CDN에만 


### 4️⃣ 마무리

설계 확장 

- API 계층의 수평적 규모 확장
- 데이터 베이스의 다중화, 샤딩
- 라이브 스트리밍 
  - 낮은 응답지연을 위한 스트리밍 프로토콜 
  - 병렬화보단 작은 단위 데이터 실시간 처리
  - 빠른 오류 처리 방안 