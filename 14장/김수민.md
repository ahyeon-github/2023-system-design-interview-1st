# 유튜브 설계

## 1단계 문제 이해 및 설계 범위 확정
- 어떤 기능이 중요한지
- 어떤 클라이언트를 지원하는지
- 일간 능동 사용자 수는 몇명인지
- 사용자가 평균적으로 소비하는 시간은 어느정도인지
- 다국어 지원이 필요한지
- 어떤 비디오 해상도를 지원해야하는지
- 암호화가 필요한지
- 비디오 파일 크기에 제한이 있는지
- 클라우드 서비스를 이용 가능한지

## 2단계 개략적 설계안 제시 및 동의 구하기
개략적으로 보면 이 시스템은 크게 세 개의 컴포넌트로 구성
- 단말
- CDN
- API 서버

주요 기능은 비디오 업르도와 스트리밍 일때 절차는 다음과 같다.

### 비디오 업로드 절차
이 설계안은 다음과 같은 컴포넌트로 구성
- 사용자
- 로드밸런서
- API 서버
- 메타데이터 데이터베이스
- 메타데이터 캐시
- 원본 저장소(BLOB 저장소 사용)
- 트랜스코딩 서버
- 트랜스코딩 비디오 저장소
- CDN
- 트랜스코딩 완료 큐
- 트랜스코딩 완료 핸들러

비디오 업로드 프로세스는 크게 두가지로 구분되고 각각은 병렬적으로 수행된다

#### process a : 비디오 업로드
1. 비디오를 원본 저장소에 업로드
2. 트랜스코딩 서버는 원본 저장소에서 해당 비디오를 가져와 트랜스코딩 시작
3. 트랜스코딩 후 두 절차가 병렬적으로 수행
   1. 완료된 비디오를 트랜스코딩 비디오 저장소로 업로드
   2. 완료 핸들러가 이벤트 데이터를 큐에서 꺼냄
   3. 완료 핸들러가 메타데이터 db와 캐시를 갱신
4. api서버가 단말에게 비디오 업로드가 끝났음을 알리고 스트리밍 준비가 완료됨을 전파

#### process b : 메타데이터 갱신
원본 저장소에 파일이 업로드되는 동안 단말은 병렬적으로 비디오 메타데이터 갱신 요청을 api 서버에 전송.

### 비디오 스트리밍 절차
스트리밍 프로토콜의 종류는 여러 가지가 존재
- MPEG-DASH
- HLS
- Microsoft Smooth Streaming
- Adobe HTTP Dynamic Streaming

비디오는 CDN에서 바로 스트리밍된다.

## 3단계 상세 설계
### 비디오 트랜스코딩
비디오를 특정 포맷으로 저장할 때 다른 단말과 호환되는 비트레이트와 포맷으로 저장되어야 한다.
이 과정은 다음과 같은 이유로 중요하다.
- 원본 비디오는 많은 용량을 차지
- 상당수의 단말과 브라우저는 특정 종류의 비디오 포맷만 지원
- 사용자에게 끊임없는 재생 보장
- 수시로 변하는 네트워크 트래픽

인코딩 포맷은 매우 다양하고 두 부분으로 구성
- 컨테이너 : 흔히 아는 mp4 mov 등
- 코덱 : 압축 및 해제 알고리즘. H.264, HEVC, VP9

### 유향 비순환 그래프(DAG) 모델
각각의 비디오마다 요구되는 사항이 다르기 때문에 작업을 단계별로 배열하여 해당 작업들이 순차적으로 또는 병렬적으로 실행될 수 있는 DAG 모델을 도입하여 유연성과 병렬성을 확보한다.

원본 비디오는 비디오, 오디오, 메타데이터 세 부분으로 나뉘어 처리되고 비디오 부분은 다음과 같다.
- 검사
- 비디오 인코딩
- 섬네일
- 워터마크

### 비디오 트랜스코딩 아키텍쳐
이 아키텍쳐는 다섯 개의 주요 컴포넌트로 구성.
- 전처리기
- DAG 스케쥴러
- 자원 관리자
- 작업 실행 서버
- 임시 저장소

#### 전처리기
- 비디오 분할 : 비디오 스트림을 GOP라고 불리는 단위로 쪼갠다.
- DAG 생성 : 클라이언트 프로그래머가 작성한 설정 파일에 따라 DAG 생성
- 데이터 캐시 : GOP와 메타데이터를 임시 저장소에 보관

#### DAG 스케쥴러
DAG 그래프를 몇 개의 단계로 분할한 다음 각각을 작업 관리자와 작업 큐에 넣는다.

#### 자원 관리자
자원 배분을 효과적으로 수행하는 역할을 담당하고 세 개의 큐(작업 큐, 작업 서버 큐, 실행 큐)와 작업 스케쥴로로 구성된다.

#### 작업 서버
DAG에 정의된 작업을 수행하며 작업 종류에 따라 작업 서버도 구분하여 관리한다.

#### 임시 저장소
메타데이터 같은 경우는 메모리에 비디오/오디오 데이터는 BLOB 저장소에 둔다. 추후에 프로세싱이 끝나면 삭제한다

#### 인코딩된 비디오

### 시스템 최적화
속도 최적화
- 비디오 병렬 업로드 (분할된 GOP 병렬 업로드)
- 업로드 센터를 사용자 근거리에 지정
- 모든 절차를 메시지 큐를 도입해서 병렬화

안정성 최적화
- 미리 사인된 업로드 URL
- 비디오 보호 (DRM, AES encryption, watermark)

비용 최적화
- 인기 비디오만 CDN에 저장

### 오류 처리
오류에 대한 전형적 해결 방법 정의
- 업로드 오류
- 비디오 분할 오류
- 트랜스코딩 오류
- 전처리 오류
- ...

## 4단계 마무리
추가 논의 사항
- API 계층의 규모 확장성 확보 방안
- 데이터베이스 계층의 규모 확장성 확보 방안
- 라이브 스트리밍
- 비디오 삭제
