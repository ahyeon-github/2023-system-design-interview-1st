# 사용자 수에 따른 규모 확장성

## 단일 서버
웹, 앱, 데이터베이스, 캐시 등이 전부 서버 한 대에서 실행되는 구조

## 데이터베이스
서버를 웹/모바일 트래픽 처리 서버와(웹 계층) 데이터베이스 서버(데이터 계층)으로 분리하여 독립적으로 확장

데이터베이스는 크게 관계형과 비관계형으로 분리
관계형의 경우 RDBMS라고 부르고 MySQL, Oracle, PostgreSQL 등이 존재하고 자료를 테이블과 열, 칼럼으로 표현한다. 주로 SQL을 사용하여 여러 테이블에 있는 데이터를 관계에 따라 join하여 합친다.

비관계형의 경우 NoSQL이라고 부르고 대표적으로 Amazon DynamoDB, HBase 등이 존재하고 크게 네 부류인 key-value store, graph store, column store, document store로 분리한다. 비관계형의 경우 일반적으로 join 연산을 지원하지 않는다.

비관계형을 주로 사용하는 경우
- 아주 낮은 응답 지연시간이 요구되는 경우
- 데이터가 비정형인 경우
- 데이터를 직렬화하거나 역직렬화 할 수 있는 경우
- 많은 양의 데이터를 저장하는 경우

## 수직적 규모 확장 vs 수평적 규모 확장
스케일 업은 주로 수직적 규모 확장, 서버에 고사양 자원을 추가하는 행위를 말하고 스케일 아웃은 수평적 규모 확장, 더 많은 서버를 추가하여 성능을 개선하는 행위를 말한다.

수직적 규모 확장의 경우 한계가 존재하고 failover 방안이나 다중화 방안을 제시하지 못하며 서버에 장애가 발생하면 서비스가 중단되게 된다.

위의 경우 때문에 수평적 규모 확장을 통해 로드밸런서를 도입해서 부하를 분산하는게 효과적
### 로드 밸런서
로드밸런서는 웹 서버들에게 트래픽 부하를 고르게 분산하는 역할을 수행. failover 문제가 해소되며 가용성이 향상

### 데이터베이스 다중화
master-slave 관계를 설정하고 데이터 원본은 master에 사본은 slave에 저장하는 방식이며 쓰기 연산 같은 데이터 변경은 master에서 읽기 연산은 slave에서 처리.
데이터베이스를 여러 지역에 분산시킴으로써 안정성을 확보하고 가용성을 향상시킬 수 있다.
master 데이터베이스가 다운되었을 때 slave 데이터베이스를 master로 승격시키고 없는 데이터는 복구 스크립트를 돌려서 추가하거나 다중 마스터나 원형 다중화 방식을 도입한다.

## 캐시
캐시는 자주 참조되는 데이터를 메모리 안에 두고 뒤이은 요청이 보다 빨리 처리될 수 있도록 하는 저장소 역할. 캐시를 사용하면 데이터베이스의 부하를 줄일 수도 있고 성능도 향상시킬 수 있다. 캐시 전략은 캐시할 데이터 종류, 크기, 액세스 패턴에 따라 다양하게 존재하고 대표적으로 데이터를 읽고 없으면 데이터베이스에서 가져오는 읽기 주도형 캐시 전략이 존재한다.

캐시 사용시 유의할 점
- 어떤 상황에 쓰이는지?
- 어떤 데이터를 저장해두는지?
- 어떻게 만료되는지?
- 일관성을 어떻게 유지되는지?
- 장애에는 어떻게 대처하는지?
- 캐시 메모리를 어느정도 잡을지?
- 데이터 방출 정책은 무엇인지?

## CDN
CDN은 정적 콘텐츠를 전송하는 데 쓰이는 지리적으로 분산된 서버의 네트워크. 동적 콘텐츠 캐싱 같은 경우는 요청 경로, 질의 문자열, 쿠키, 요청 헤더 등의 정보에 기반하여 HTML 페이지를 캐시하는 것이다. CDN 같은 경우 제3 사업자에 의해 운영이 되고 들어가고 나가는 데이터 전송 양에 따라 요금을 부과하게 되며 적절한 만료 시한 설정과 콘텐츠 변경에 따른 콘텐츠 무효화 방법이 필요하다.

## 무상태 웹 계층
웹 계층을 수평적으로 확장하기 위해서는 사용자 정보 같은 상태 정보를 지속성 저장소에 보관하고 필요할 때 가져오도록 수정해야한다.
웹서버의 상태 정보가 필요할 경우 공유 저장소로부터(데이터베이스, 캐시 메모리 등) 데이터를 가져오도록 수정한다. 이렇게 되면 상태 정보는 웹 서버로부터 물리적으로 분리되게 되고 웹 서버 계층의 규모 확장이 용이해진다.

## 데이터 센터
보통 장애가 없는 상황에서 사용자는 가장 가까운 데이터 센터로 안내가 되고 통상 이 절차를 지리적 라우팅 (geoDNS-routing or geo-routing)이라고 부른다.
다중 데이터센터 아키텍쳐를 만들기 위한 해결해야할 난제
- 트래픽 우회: 올바른 데이터 센터로 트래픽 전송
- 데이터 동기화: 여러 데이터 센터에 걸친 데이터 다중화
- 테스트와 배포: 여러 리전에서의 테스트와 배포

## 메시지 큐
메시지 큐는 메시지의 무손실을 보장하는 비동기 통신을 지원하는 컴포넌트. 메시지 큐를 이용하게 되면 서비스 또는 서버 간 결합이 느슨해지게 되고, 규모 확장성이 필요한 애플리케이션을 안정적으로 구성하기 좋다. 메시지 큐의 구조는 버퍼에 publisher가 메시지를 publish하면 consumer가 메시지를 가져가서 처리하는 구조이다.

## 로그, 메트릭 그리고 자동화
에러 로그 같은 경우는 모니터링하는 것이 매우 중요하다. 시스템의 오류와 문제들을 보다 쉽게 찾아낼 수 있도록 해주기 때문이다. 에러 로그는 서버 단위로 모니터링 하기 보다 하나의 단일 서비스로 모아서 처리해야 효과적이다.

메트릭 같은 경우 잘 수집만 하면 유용한 정보나 시스템의 현재 상태를 손쉽게 파악할 수 있다.
- 호스트 단위 메트릭
- 종합 메트릭
- 핵심 비즈니스 메트릭

자동화는 생산성을 높이기 위해서 자동화 도구를 활용해 일련의 과정들을 자동으로 처리하게 하는 프로세스이다. 주로 CI/CD를 자동화하게 되고 빌드, 테스트, 배포 등의 절차를 자동화하여 개발 생산성을 향상시킨다.

## 데이터베이스의 규모 확장
저장할 데이터가 많아지면 데이터베이스에도 부하가 증가하게 된다.

### 수직적 확장
기존 서버에 더 높은 사양을 적용하는 방법으로 CPU, RAM 등을 늘리는 방법이다. 하지만 이 방법은 SPOF 문제가 있고 한계가 존재한다.

### 수평적 확장
보통 데이터베이스의 수평적 확장은 sharding이라고 부르는데 더 많은 서버를 추가함으로써 성능을 향상시킬 수 있다.
샤딩은 대규모 DB를 샤드라고 부르는 작은 단위로 분할하는 기술이고 모든 샤드는 같은 스키마를 쓰지만 샤드에 보관되는 데이터 사이에는 중복이 없다.
샤딩 키에 따라 데이터가 보관되는 곳이 다르고 파티션 키라고도 부르는데, 데이터가 어떻게 분산될지 정하는 하나 이상의 칼럼으로 구성된다.