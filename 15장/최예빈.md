## 구글 드라이브 설계  

> 구글 문서의 편집 및 협업 기능이 제일 궁금한데 이건 제외한 파일 저장소 서비스를 설계한다. 

### 1️⃣ 문제 이해 및 설계 범위 확정

기능적 요구사항 

- 파일 추가. 
- 파일 다운로드. 
- 여러 단말에 파일 동기화.
- 파일 갱신 이력 조회.
- 파일 공유.
- 파일 편집/삭제/공유 시 알림.

비기능적 요구사항

- 데이터 안정성
- 빠른 동기화 속도
- 네트워크 대역폭 최적화
- 규모 확장성
- 높은 가용성 

개략적 추정치

- 사용자 50million, DAU 10million
- 모든 사용자에게 10GB의 무료 저장 공간 할당
- 매일 각 사용자가 평균 2개의 파일을 업로드 한다고 가정. 각 파일의 평균 크기 500KB
- 읽기:쓰기 = 1:1
- 필요 저장 공간 총량 = 50m * 10GB = 500PB
- 업로드 API QPS = 10m * 2회/24시간/3600초 = 초당 240
- 최대 QPS = 240 * 2 = 480


### 2️⃣ 개략적 설계안 제시 및 동의 구하기

구성

- 파일 업로드/다운로드 과정 처리할 웹 서버
- 사용자 데이터, 로그인 정보, 파일 정보 등 메타데이터 보관 DB
- 파일 저장 공간

확장

- 파일 저장소 여러 지역에 걸쳐 다중화 
- 로드 밸런서, 웹 서버 추가 
- 메타데이터 데이터베이스 분리

동기화 충돌 해결

[Differential Synchronization - Neil Fraser](https://neil.fraser.name/writing/sync/)

개략적 설계안




### 3️⃣ 상세 설계

#### 블록 저장소 서버

업데이트가 일어날 때마다 전체 파일을 서버로 보내면 네트워크 대역폭을 많이 잡아먹음. 

- 델타 동기화: 수정이 일어난 블록만 동기화  
- 압축: 블록단위로 압축. 

블록은 파일을 나눈 단위 컴포넌트로 클라이언트가 파일을 보내면 블록으로 분할->압축->암호화를 거쳐 클라우드 저장소로 보낸다. 

#### 메타데이터 데이터베이스

같은 파일에 대한 강한 일관성을 유지한다. 

- 캐시의 사본과 DB의 원본이 일치해야 한다
- 원본에 변경이 발생하면 캐시의 사본을 무효화 한다


#### 업로드 절차

파일을 업로드하면 두 개의 요청이 병렬적으로 전송된다

- 파일 메타데이터 추가
- 파일을 클라우드 저장소에 업로드 


#### 다운로드 절차

파일 다운로드는 파일 추가, 편집 시 자동으로 시작된다. 그렇다면 클라이언트는 파일 편집/추가를 어떻게 감지할까?

- 클라이언트 A가 접속 중이고 다른 클라이언트가 파일을 변경하면 알림 서비스가 A에게 변경을 알려 새 버전을 끌어가도록 한다.
- 클라이언트 A가 네트워크에 연결된 상태가 아니면 데이터가 캐시에 보관되고 A가 접속 하면 그때 클라이언트가 새 버전을 끌어온다.


#### 알림 서비스

파일 일관성을 위해 클라이언트가 로컬에서 파일이 수정되었음을 감지하는 순간 서버가 다른 클라이언트에 알린다. 

- 롱 폴링: 드롭 박스도 사용한다. 채팅과 달리 서버->클라이언트 방향의 통신만 필요하다. 알림을 자주 보내지 않으며 단시간에 많은 양을 보내지도 않는다. 
- 웹소켓: 알림보단 채팅 서비스에 더 적합하다. 


#### 파일 저장소 공간

- 중복된 파일 블록 제거
- 파일 버전 한도 설정, 중요 버전만 보관
- 아카이빙 저장소(Amazon S3 Glacier) 도입


#### 장애 흐름 처리 

- 로드밸런서 장애 : 로드 밸런서끼리 보통 박동(heartbeat) 신호를 보내서 상태를 모니터링 함
- 블록 저장소 서버 장애 : 다중화 저장소로 이동
- 클라우드 저장소 장애 : 다중화 저장소로 이동
- API 서버 장애 : API서버들은 무상태 서버. 로드밸런서는 API서버에 장애가 발생하면 트래픽을 해당 서버로 보내지 않음으로써 장애 서버를 격리할 것
- 메타데이터 캐시 장애 : 다중화 주/부 데이터베이스로 이동
- 메타데이터 데이터베이스 장애 : 다중화 주/부 데이터베이스로 이동
- 알림 서비스 장애 : 한 대 서버에 장애가 발생하면 수만 명 이상의 사용자가 롱 폴링 연결을 다시 만들어야 함 - 복구 시 시간 오래 걸림
- 오프라인 사용자 백업 큐 장애 : 큐에 장애가 발생하면 구독 중인 클라이언트 들은 백업 큐로 구독 관계를 재설정해야함.
