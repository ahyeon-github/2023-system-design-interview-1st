# 10장_알림 시스템 설계

## 알림 유형별 지원 방안

### ios 푸시 알림

컴포넌트

- provider
    - 알림 요청을 만들어 APNS로 보내는 주체
    - 알림 요청을 만들때 필요한 데이터
        - device token : 고유 식별자
        - payload : 알림 내용을 담은 JSON 딕셔너리
- APNS(apple push notification service)
    - 푸시 알림을 ios 장치로 보내는 역할
- ios 단말

### 안드로이드 푸시 알림

- provider → FCM (firebase cloud messaging) → 안드로이드 단말

### SMS 메시지

- provider → SMS 서비스 → SMS 수신 단말

### 이메일

- provider → 이메일 서비스 → 이메일 수신 단말
    - 많은 회사가 상용 이메일 서비스를 사용함
        - ex) Sendgrid, Mailchimp
        - 전송 성공률이 높고, 데이터 분석 서비스도 제고앟ㅁ

## 연락처 정보 수집 절차

- 알림을 보내려면 모바일 단말 토큰, 전화번호 등의 정보가 필요함
- 사용자 단말 → 앱설치 → 로드 밸런서 → API 서버 → 연락처 정보 DB에 저장

## 알림 전송 및 수신 절차

- 서비스 1~N
- 알림 시스템
    - 캐시, DB를 알림 시스템의 주 서버에서 분리
        - 규모 확장성
    - 알림 서버 - 작업 서버 나눔
        - **메시지 큐**를 이용해 **시스템 컴포넌트 사이의 강한 결합을 끊을 수 있음**
        - SPOF 방지
        - 알림 서버
            - 서비스 1~N에 알림 전송을 위한 API 제공
            - 제3자 서비스에 전달할 알림 payload 생성, 메시지 큐에 넣음
        - 작업 서버
            - 메시지 큐에서 알림을 꺼내서 제3자 서비스에 전달
- 제3자 제공 서비스
    - 알림을 단말에 전송
    - extensibility가 있어야 함 (서비스 통합, 제거 가능)
- 단말
    - 알림 수신
    

## 안정성

### 데이터 손실 방지

- 알림 데이터를 DB에 보관하고, 재시도 매커니즘을 구현해야함
- 방법 : notification log DB 유지하기

### 알림 중복 전송 방지

- 분산 시스템 특성상, 가끔 같은 알림이 중복으로 전송되기도 함
- 방법 : 중복 탐지 매커니즘 도입, 오류 처리
    - 보내야 할 알림이 도착하면 해당 이벤트의 ID를 검사하여 이전에 봤던 이벤트인지 살핌 → 봤던거면 버리고, 아니면 알림 발송

## 추가로 필요한 컴포넌트 및 고려사항

### 알림 템플릿

- parameter, style, tracking link를 조정하면 사전에 지정한 형식에 맞춰 알람을 만들어내는 틀
- 알림의 형식을 일관성있게 유지해줌
- 알림 작성 시간 줄일 수 있음

### 알림 설정

- 알림 설정 테이블에 user_id, channel(알림이 전송될 채널), opt_in(알림 받을지 여부) 저장해두고, 알림 보내기 전에 사용자가 알림 받는다고 해뒀는지 확인

### 전송률 제한

- 한 사용자가 받을 수 있는 알림의 빈도 제한

### 재시도 방법

- 제3자 서비스가 알림 전송에 실패하면, 해당 알림을 ‘재시도 전용 큐’에 넣음

### 푸시 알림과 보안

- 인증된 클라이언트만 알림 전송 API를 사용하여 알림을 보낼 수 있음

### 큐 모니터링

- 큐에 쌓이는 알림의 개수를 모니터링 → 너무 많이 쌓이면 작업 서버 증설

### 이벤트 추적

- 알림 확인율, 클릭율, 실제 앱 사용으로 이어지는 비율 등 분석
