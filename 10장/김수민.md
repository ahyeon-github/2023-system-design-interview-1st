# 알림 시스템 설계
알림 시스템은 최그 많은 프로그램에서 채택되고 있는 기능이다. 이는 중요할 만한 정보들을 비동기적으로 고객에게 제공한다.

### 1단계 문제 이해 및 설계 범위 확정
질문을 통해 알림 시스템을 어떻게 구현할지에 대한 요구사항을 파악한다.
- 실시간 시스템인지?
- 어떤 종류의 알림을 지원하는지?
- 어떤 종류의 단말을 지원하는지?
- 알림을 누가 생성할지?
- 하루의 몇 건을 보낼 수 있을지?

### 2단계 개략적 설계안 제시 및 동의 구하기

#### 알림 유형별 지원 방안

* ios 푸시 알림
  * 알림 제공자
    * 단말 토큰
    * 페이로드
  * APNS
  * ios 단말
* 안드로이드 푸시 알림
  * 위와 동일하고 APNS 대신 FCM을 사용
* SMS 메시지
  * 제3 사업자의 서비스를 주로 사용
* 이메일


#### 연락처 정보 수집 절차
데이터베이스 정보로부터 이메일 주소와 전화번호 등을 수집한다.

#### 알림 전송 및 수신 절차
기본 구조는 여러 개의 서비스 (과금이나 배송 등) -> 알림 시스템 -> 제3자 제공 서비스 -> 단말기로 가는 구조이다.
하지만 이 설계는 SPOF와 규모 확장성, 성능 병목의 문제가 존재한다.

이러한 문제를 해결하기 위해 알림 서버를 다음과 같이 분리한다.
- 알림 서버
- 캐시
- 데이터베이스
- 메시지 큐
- 작업 서버

### 3단계 상세 설계

#### 안정성
분산 환경에서 안정성을 확보하기 위해서는 몇 가지 사항을 고려해야한다.
- 데이터 손실 방지 : 알림 로그 데이터베이스를 유지
- 알림 중복 전송 방지 : 이벤트 id를 활용한 중복 이벤트 여부 확인

#### 추가로 필요한 컴포넌트 및 고려사항
- 알람 템플릿 : 메시지의 유사성을 고려해서 처음부터 다시 만들 필요가 없도록 한다
- 알림 설정 : 사용자가 알림 설정을 상세히 조정할 수 있도록 한다
- 전송률 제한 : 한 사용자가 받을 수 있는 알림의 빈도를 제한한다
- 재시도 방법 : 알림 전송에 실패하면 해당 알림을 재시도 큐에 넣고 반복돼서 발생하면 개발자에게 alert한다
- 푸시 알림과 보안 : 인증된 클라이언트만 해당 api를 사용하여 알림을 보낼 수 있도록 appKey와 appSecret을 사용한다
- 큐 모니터링 : 큐에 쌓인 알림의 개수를 메트릭 단위로 하여 수집해서 작업 서버의 성능을 판단한다
- 이벤트 추적 : 데이터 분석 서비스를 이용해서 이벤트를 추적한다

### 4단계 마무리

- 안정성 : 재시도 메커니즘을 통한 실패율을 낮춤
- 보안 : appKey, appSecret 등의 메커니즘을 사용하여 보안 강화
- 이벤트 추적 및 모니터링 : 알림의 전체적인 과정을 모니터링하고 모니터링 할 수 있는 시스템 통합
- 사용자 설정 : 사용자가 알림 수신 설정
- 전송률 제한 : 사용자에게 알림을 보내는 빈도를 제한