# 채팅 시스템 설계

## 1단계 문제 이해 및 설계 범위 확정
어떤 유형의 앱을 원하는지 질문을 통해 파악
- 1대1인지 그룹인지
- 트래픽 규모는 어느정도 인지
- 그룹채팅의 경우엔 인원 제한이 있는지
- 중요 기능으로 어떤 것이 있는지
- 메시지 길이에 제한이 있는지
- 종단 간 암호화가 필요한지
- 채팅 이력은 얼마나 오래 보관해야하는지

## 2단계 개략적 설계안 제시 및 동의 구하기
클라이언트는 서로 직접 통신하지 않고 채팅 서비스는 아래의 기능들을 보유해야함
- 클라이언트들로부터 메시지 수신
- 메시지 수신자 결정 및 전달
- 수신자가 접속 상태가 아닌 경우에는 접속할 때까지 해당 메시지 보관

또한, 채팅의 경우 어떤 프로토콜을 사용할지도 중요하다. 하지만 HTTP같은 프로토콜은 클라이언트가 연결을 만드는 프로토콜이므로 폴링, 롱 폴링, 웹소켓 등의 기술이 필요하다.

### 폴링
폴링은 클라이언트가 주기적으로 서버에게 새 메시지가 있냐고 물어보는 방법
=> 서버 자원이 불필요하게 낭비
### 롱 폴링
롱 폴링의 경우 클라이언트는 새 메시지가 반환되거나 타임아웃 될 떄까지 연결을 유지한다.
=> 이 방식도 클라이언트가 타임아웃 될때마다 주기적으로 서버에 재접속하므로 불필요
### 웹소켓
웹소켓은 서버가 클라이언트에게 비동기 메시지를 보낼 때 주로 사용하는 기술.
웹소켓 연결은 클라이언트가 시작하고 한번 맺어진 연결은 항구적이며 양방향이다. 처음에 http 핸드세이크를 맺은 뒤에 메시지 양방향 전송을 한다.

### 개략적 설계안

#### 무상태 서비스
전통적으인 req/res 구조이며 로그인, 회원가입 등의 기능을 수행한다. 이는 로드밸런서 뒷단에 존재하고 이들 가운데 서비스 탐색도 포함되는데 이는 채팅 서버의 dns 호스트명을 클라이언트에게 알려주는 역할을 한다.

#### 상태 유지 서비스
상태 유지가 필요한 서비스는 채팅 서비스로 각 클라이언트가 채팅 서버와 독립적인 네트워크 연결을 유지해야한다.

#### 제3자 서비스 연동
푸시 알림 서비스 연동

#### 규모 확장성
서버를 하나로 시작해서 점차 늘려가는 방안을 선택한다.

#### 저장소
채팅 시스템에서 다루는 데이터는 보통 두 가지로 사용자 프로파일, 설정, 친구 목록같은 일반 데이터와 채팅 이력이다. 전자의 경우 RDB에 보관하고 후자의 경우엔 키-값 저장소를 이용하여 저장한다.

#### 데이터 모델
키-값 저장소를 사용할 경우 메시지 데이터를 어떻게 보관할지도 중요하다.
메시지 아이디를 고유키로 할 경우 두 메시지가 동시에 만들어질 수 있고 채널별로 구분이 필요하다.
따라서 채널 아이디와 메시지 아이디를 복합키로 설장해 기본키로 사용하고 수신자와 송신자의 정보를 추가한다.

메시지 아이디의 경우 고유해야 하며 정렬 가능하고 시간 순서와 일치해야한다.

## 3단계 상세 설계

### 서비스 탐색
서비스 탐색의 주기능은 클라이언트에게 가장 적합한 채팅 서버를 추천하는 것이다. 이때 사용되는 기준으로는 클라이언트의 위치, 서버의 용량 등이 있다.

### 메시지 흐름

#### 1대1 채팅 메시지 처리 흐름
사용자 a가 채팅 서버 1로 메시지 전송 -> 서버1의 id 생성기를 통해 해당 메시지의 id 결정 -> 서버 1은 해당 메시지를 동기화 큐로 전송 -> 메시지가 키-값 저장소에 보관 -> 사용자 b가 접속 중인 경우엔 해당 사용자의 채팅 서버에 그렇지 않은 경우엔 알림 메시지를 푸시 알림 서버로 보냄

#### 여러 단말 사이의 메시지 동기화
여러 단말이 있는 경우 각 단말은 cur_max_message_id라는 변수를 유지해서 해당 단말에서 관측된 가장 최신 메시지의 id를 추적한다.

#### 소규모 그룹 채팅에서의 메시지 흐름
소규모의 경우 사용자에게 메시지를 보낼 떄 채팅 서버를 거쳐서 사용자의 메시지 동기화 큐로 보내게 된다.

### 접속 상태 표시

#### 사용자 로그인
클라이언트와 실시간 서비스 사이에 웹소켓 연결이 맺어지고 나면 접속상태 서버는 a의 상태와 최근 접속한 타임스탬ㄹ프 값을 키-값 저장소에 보관한다. 이 절차가 끝나면 해당 사용자는 접속 중인 것으로 표시된다.

#### 로그아웃
키-값 저장소에 보관된 사용자 상태를 온라인에서 오프라인으로 바꾼다.

#### 접속 장애
주기적으로 박동 이벤트를 접속상태 서버로 보내도록 하고 하지만 특정 시간 이후에 오지 않으면 오프라인 처리한다.

#### 상태 정보의 전송
그룹 크기가 작을때는 사용자 별로 서로 접속상태 서비스를 위한 채널을 사용하고 상대방 사용자가 구독하도록 하는 방법을 사용한다.

## 4단계 마무리
추가로 논의할 사항
- 채팅을 텍스트 말고 미디어 개체도 지원하도록 하는 방법
- 종단 간 암호화
- 캐시
- 로딩 속도 개선
- 오류 처리