# 뉴스 피드 설계
뉴스 피드란 지속적으로 업데이트 되는 스토리들이다.

### 1단계 문제 이해 및 설계 범위 확정
최소한의 어떤 기능을 지원할지 먼저 파악한다.
- 모바일 앱인지?
- 중요한 기능은 무엇인지?
- 뉴스 피드 순서는 어떤지?
- 팔로우 수는 어느정도까지인지
- 트래픽 규모는 어느 정도인지
- 피드에 올릴 수 있는 컨텐츠는 무엇인지

### 2단계 개략적 설계안 제시 및 동의 구하기

#### 뉴스 피드 API
뉴스 피드 api는 클라이언트가 서버와 통신하기 위해 사용하는 수단으로 http 프로토콜 기반이고 뉴스 피드를 가져오거나 상태 정보를 업데이트하는 등의 작업을 수행하는데 사용한다.

1. 피드 발행 API
새 스토리를 포스팅하기 위한 api로, http post 형태로 요청을 보내면 된다

2. 피드 읽기 API
뉴스 피드를 가져오는 api로 get요청을 보내면 된다.

#### 피드 발행
피드 발행 시스템은 다음과 같이 구성되어 있다.
- 사용자
- 로드밸런서
- 웹 서버
- 포스팅 저장 서비스
- 포스팅 전송 서비스
- 알림 서비스

#### 뉴스 피드 생성
뉴스 피드 생성 시스템은 다음과 같이 구성되어 있다.
- 사용자
- 로드 밸런서
- 웹 서버
- 뉴스 피드 서비스
- 뉴스 피드 캐시


### 3단계 상세 설계

#### 피드 발행 흐름 상세 설계

1. 웹 서버
클라이언트와 통신할 뿐 아니라 인증이나 처리율 제한 등의 기능도 수행한다.

2. 포스팅 전송(팬아웃) 서비스
새 포스팅을 그 사용자와 친구 관계에 있는 모든 사용자에게 전달하는 과정이다.
두가지 모델이 존재하는데 하나는 쓰기 시점에 팬아웃(푸시 모델)하는 모델이고 다른 하나는 읽기 시점에 팬아웃(풀 모델)하는 모델이다.

쓰기 시점에 팬아웃하는 모델의 경우 포스팅이 완료되면 바로 해당 사용자의 캐시에 해당 포스팅을 기록하는 방식으로 친구 목록에 있는 사용자에게 바로 전송되어서 새 피드를 읽을 때 시간이 적게 들지만 목록에 있는 친구를 찾고 그걸 갱신하는 데 많은 시간이 소요될 수 있다.

빈대로 읽기 시점에 팬아웃하는 모델의 경우 피드를 읽으려 할때 뉴스 피드를 갱신하기 때문에 요청 기반의 기법이다. 이 모델의 경우 친구 각각에 푸시할 필요가 없고 거의 로그인하지 않는 사용자의 경우 유리하다는 장점이 있지만 팔로우가 많을 경우 뉴스 피드를 읽는 데 많은 시간이 소요될 수 있다.

그래서 두개를 모두 결합한 대부분의 사용자에 대해서 push 모델을 적용하고 팔로우가 많은 사용자의 경우엔 pull 모델을 적용하여 시스템 과부하를 방지한다. 또한, 안정 해시 기법을 통해 요청과 데이터를 보다 고르게 분산하여 핫키 문제를 줄인다.

#### 피드 읽기 흐름 상세 설계
1. 사용자가 뉴스 피드를 get 요청
2. 로드밸런서가 웹서버로 요청을 보낸다
3. 웹 서버는 피드를 get하기 위해 뉴스 피드 서비스를 호출
4. 뉴스 피드 서비는 뉴스 피드 캐시에서 포스팅 id 목록을 get
5. 뉴스 피드에 표시할 데이터를 사용자 캐시와 포스팅 캐시에서 가져와 완전한 뉴스 피드 생성
6. 생성된 뉴스 피드를 json 형태로 클라이언트에게 전송. 클라이언트는 해당 피드를 렌더링

#### 캐시 구조
캐시를 여기선 다섯 계층으로 나눈다.
- 뉴스 피드 : 뉴스 피드의 id를 보관
- 콘텐츠 : 포스팅 데이터 보관, 인기 콘텐츠는 따로 보관
- 소셜 그래프 : 사용자 간의 관계 정보
- 행동 : 사용자의 행위에 대한 정보
- 횟수 : 좋아요 횟수, 응답 수, 팔로워 수 등의 정보
