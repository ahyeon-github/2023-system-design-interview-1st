# 11장_뉴스 피드 시스템 설계

# 문제 이해 및 설계 범위 확정

질문

- 모바일 앱 vs 웹 어떤걸 위한 서비스인지
- 중요한 기능으로 무엇이 있는지
- 어떤 순서로 피드에 스토리가 표시되어야 하는지
- 한명의 사용자는 최대 몇명의 친구를 가질 수 있는지
- 트래픽 규모는 어떻게 되는지
- 피드에 올릴 수 있는 파일 형식

# 기능

## 피드 발행

- 사용자가 스토리를 포스팅하면, 해당 데이터를 캐시와 DB에 기록
- 새 포스팅은 친구의 피드에도 전송됨
- 포스팅 저장 서비스
    - 새 포스팅을 DB, cache에 저장
- 포스팅 전송 서비스
    - 새 포스팅을 친구의 피드에 push
    - 피드 cache에 데이터 보관
- 알림 서비스
    - 친구들에게 새 포스팅이 올라왔음을 알림

### 웹서버

- 인증 : 올바른 인증 토큰을 authorization 헤더에 넣고 API를 호출하는 사용자만 포스팅 할 수 있도록 함
- 처리율 제한 : 특정 기간 동안 한 사용자가 올릴 수 있는 포스팅 개수 제한

### 포스팅 전송(fanout) 서비스

- 어떤 사용자의 새 포스팅을 친구들에게 전달
- 대부분의 사용자에 대해서는 push 모델 사용, follower가 많은 사용자의 경우에는 pull 모델 사용
    - push 모델
        - 포스팅이 완료되면 바로 친구의 캐시에 해당 포스팅을 기록함 (친구 피드 갱신)
        - 뉴스 피드를 빠르게 가져올 수 있음
    - pull 모델
        - 사용자가 본인 타임라인을 로딩하는 시점에 새로운 포스트를 가져옴
        - 시스템 과부하 방지 (hotkey 방지)
- 안정 해시를 통해 요청과 데이터를 고르게 분산 → hotkey 문제 줄임
- 동작 흐름
    - 그래프 DB에서 친구 ID 목록 가져옴
    - 사용자 정보 cache에서 친구들의 정보 가져옴
    - 친구 목록과 새 스토리의 포스팅 ID를 메시지 큐에 넣음
    - 포스팅 전송 작업 서버가 메시지 큐에서 데이터를 꺼내어 뉴스 피드 cache에 넣음
        - 캐시에 저장된 매핑 테이블 구조: <포스팅ID, 사용자ID>

## 피드 읽기

- 이미지/비디오 같은 미디어 컨텐츠는 CDN에 저장 → 빨리 읽을 수 있음
- 뉴스 피드 서비스
    - cache에서 뉴스 피드를 가져옴
        - cache : 뉴스 피드를 렌더링 할 때 필요한 피드 ID 보관
- 동작 흐름
    - 사용자가 뉴스 피드 읽기 요청 보냄
    - **로드 밸런서**가 요청을 **웹 서버** 중 하나에 보냄
    - 웹서버가 **뉴스 피드 서비스** 호출
    - 뉴스 피드 서비스는 **뉴스 피드 cache**에서 포스팅 ID 목록을 가져옴
    - 뉴스피드 서비스는 사용자 정보 캐시, 포스팅 캐시에서 데이터를 가져와서 뉴스 피드를 만듬
    - 생성된 뉴스 피드를 JSON 형태로 클라이언트에게 보냄

## 뉴스 피드 API

- 클라이언트가 서버와 통신하기 위한 수단
- HTTP 프로토콜 기반

### 피드 발행 API

- HTTP POST
- body : 포스팅 내용
- authorization 헤더 : API 호출 인증하는데 사용

### 피드 읽기 API

- HTTP POST
- authorization 헤더 : API 호출 인증하는데 사용
