# URL 단축기 설계

## 1단계 문제 이해 및 설계 범위 확정
질문을 통해 모호함을 줄이고 요구사항을 파악한다.
제한 사항이나 기능, 규모 측면에서 질문을 통해 요구사항을 확인한다.

## 2단계 개략적 설계안 저시 및 동의 구하기

#### API 엔드포인트
서버가 제공하는 엔드포인트를 통해 클라이언트는 서버와 통신을 하게된다.
url 단축기는 기본적으로 두개의 엔드포인트가 필요하다
- url 단축용 엔드포인트 : 새 단축 url을 생성하고자 하는 클라이언트는 이 엔드포인트에 단축할 url을 인자로 실어서 post 요청을 보내야한다.
- url 리디렉션 엔드포인트 : 단축 url에 대하여 http요청이 오면 원래 url로 보내주기 위한 용도의 엔드포인트

#### URL 리디렉션
단축 url이 오면 서버는 301이나 302 응답의 location 헤더에 넣어 반환한다.
둘의 차이는 301 같은 경우 응답을 캐시해서 추후에 또 요청을 보낼 필요가 있을 때 캐시된 원래 url로 요청을 보내고 302sms 일시적으로 location 헤데어 넣어서 처리된다.

#### URL 단축
긴 url을 해시 값으로 대응시킬 해시 함수를 찾는 것이 관건이다.

## 3단계 상세 설계
#### 데이터 모델
<단축 url, 원래 url> 의 순서쌍을 관계형 디비에 저장하는 방식으로 해시 테이블을 단순화한다.

#### 해시 함수
hashValue의 길이에 따라 만들어낼 수 있는 개수가 다르고 잘 비교해서 길이를 지정한다.
그 후 해시 함수 구현에 쓰일 길수인 해시 후 충돌 해소 방법과 base-62 변환 방법에 대해 살펴본다.

##### 해시 후 충돌 해소
기존의 해시 함수인 CRC32, MD5, SHA-1은 7보다 길어서 처음 7개 길이만 이용한다면 충돌이 일어날 확률이 높다. 따라서 해소될 때까지 사전에 정한 문자열을 해시값에 덧붙인다. 이 방법을 쓰면 해소는 되지만 단축 url을 만들때 한번 더 이상 db에 질의를 해야해서 오버헤드가 크다. 따라서 블룸 필터를 활용하면 성능을 더 높일 수 있다.

##### base-62 변환
62진법을 쓰는 이유는 hashValue에 사용할 수 있는 문자 개수가 62개이기 때문이다. 이 방법은 유일성이 보장되기 때문에 이전과 다르게 충돌될 일이 없다. 하지만 추측이 가능하므로 보안상 문제가 될 수도 있다.

#### URL 단축기 상세 설계
논리적인 흐름으로 전체적인 과정을 정리한다.
긴 url을 입력으로 받은 후 -> url db 여부 확인 -> db에서 찾으면 반환 그렇지 않으면 새로운 id 생성 -> base-62 변환 적용 후 단축 url 생성 -> db에 저장 후 반환

#### URL 리디렉션 상세 설계
사용자가 단축 url 클릭 -> 로드밸런서가 해당 요청을 웹 서버에 전달 -> 단축 url이 캐시에 있는 경우 read -> 없는 경우 데이터베이스에서 read 그래도 없다면 잘못 입력한 경우로 판단 -> 데이터베이스에서 꺼낸 url 캐시에 저장후 사용자에게 반환

## 4단계 마무리
이후에도 처리율 제한 장치라던가 웹 서버의 규모 확장, 데이터베이스의 규모 확장, 데이터 분석 솔루션, 가용성, 데이터 일관성, 안정성에 대해 더 고민할 필요가 있다.