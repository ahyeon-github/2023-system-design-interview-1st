# 6장_키-값 저장소 설계

# 키-값 저장소 (key-value store)

- non-relational DB
- 키-값 데이터베이스라고도 불림
- 이 저장소에 저장되는 값은 고유 식별자(identifier)를 키로 가져야 함
    - 키는 짧을수록 좋음
    - 키 값 : 해시 값 혹은 일반 텍스트
- 예) Amazon Dynamo, memcached, Redis

# 문제 이해 및 설계 범위 확정

- 읽기, 쓰기, 메모 사용량 사이에 균형을 찾고
- 데이터의 일관성과 가용성 사이에 타협적 결정 내리기

# 단일 서버 키-값 저장소

- 설계 쉬움
- 키-값 쌍 모두 메모에 해시 테이블로 저장 (직관적인 방법)
    - 장점 : 빠른 속도
    - 단점 : 모든 데이터를 메모리 안에 두는 것은 불가능 할 수 있음
        - 해결 방법
            - 데이터 압축 (compression)
            - 자주 쓰는 데이터만 메모리에 두고 나머지는 디스크에 저장
- 많은 데이터를 저장하려면 한 대의 서버로는 부족함 → 분산 키-값 저장소 필요

# 분산 키-값 저장소

: 분산 해시 테이블

## CAP 정리

: Consistency, Availability, Partition Tolerance theorem 세가지를 동시에 만족하는 분산시스템을 설계하는 것은 불가능하다 (두 개 만족하면 하나는 만족x)

- Consistency
    - 분산 시스템에 접속하는 모든 client는 접속한 노드와 관계없이, 언제나 같은 데이터를 보게 되어야 한다
- Availability
    - 일부 노드에 장애가 발생해도, 분산 시스템에 접속하는 모든 client는 항상 응답을 받을 수 있어야 한다
- Parition Tolerance theorem
    - 네트워크에 partition이 생겨도 시스템은 계속 동작해야 한다
        - partition : 두 노드 사이에 발생한 통신 장애

분류 (어떤 2가지 조건을 만족하느냐에 따라 분류됌)

- CP
- AP
- CA
    - 이런 시스템은 존재하지 않음
    - 통상 네트워크 장애는 피할 수 없는 일로 여겨져서 P는 꼭 필요함.

### 실세계의 분산 시스템

- partition 문제를 피할 수 없음
    - partition 문제 발생 시, 일관성(C)과 가용성(A)중 하나를 선택해야 함
    - 은행권 시스템은 보통 일관성 선택 (데이터 불일치 문제를 피하기 위해 다른 노드들에 대해 쓰기 연산을 중단시킴 → 가용성 깨짐)

## 시스템 컴포넌트

### 데이터 파티션

- 데이터를 작은 파티션들로 분할한 다음, 여러 대의 서버에 저장
- 분할시 고려할 점
    - 데이터를 여러 서버에 고르게 분산할 수 있는가
    - 노드 추가/삭제 시 데이터의 이동을 최소화할 수 있는가
- 5장의 안정 해시는 데이터 파티션에 적합한 기술!
    - 안정해시를 사용하면 좋은 점
        - 규모 확장 자동화 : 시스템 부하에 따라 서버가 자동으로 추가/삭제되게 만들 수 있음
        - 다양성 : 각 서버의 용량에 맞게 가상 노드의 수를 조정할 수 있음 (고성능 서버 → 많은 가상노드)

### 데이터 다중화

- 높은 가용성과 안정성을 확보하기 위해, 데이터를 여러개의 서버에 비동기적으로 사본 보관함

### 데이터 일관성

- 여러 노드에 다중화된 데이터는 적절히 동기화 되어야 함
- Quorum Consensus 프로토콜 사용
