# 안정 해시 설계
수평적 규모 확장성을 달성하기 위해서는 요청 또는 데이터를 서버에 균등하게 나누는 것이 중요. 이때 사용하는 기술이 해시 기술이다.
## 해 키 재배치 문제
기존의 해시 함수를 활용해서 서버들에 부하를 균등하게 분산하는 것이 보편적이었지만 이 방법은 하나의 서버가 장애가 났을 시에 서버를 재배치하고 대부분 키도 다시 재배치 하게 되어서 대규모 cache miss가 난다는 문제점이 존재한다. 

## 안정 해시
해시 테이블 크기가 조정될 때 평균적으로 오직 k/n개의 키반 재배치하는 해시 기술이다. 이 기술은 해시 공간의 양쪽을 구부려서 해시 링을 만들게 되고 이 링 위에 해시 서버와 해시 키를 배치하게 된다. 이때 서버와 키를 배치할 때는 균등 분포 해시 함수를 사용하여 해시 링에 배치하게 된다. 키가 어느 서버에 존재하는 서버를 조회하기 위해서는 해당 키의 위치로부터 시계 방향으로 링을 탐색해 나가면서 만나는 첫 번째 서버를 찾으면 된다. 이 방법을 이용해서 서버가 새로 추가되거나 삭제될 때 그 서버 사이에 있는 키만 재배치하면 되기 때문에 기존의 방법보다 개선된다.

### 기본 구현법의 두 가지 문제
하지만 이 방법에는 파티션(인접한 서버 사이의 해시 공간)의 크기를 균등하게 유지하는 게 불가능하다는 문제점과 키의 균등 분포를 달성하기 어렵다는 점이 존재한다.
이를 해결하기 위해 제안된 기법이 가상 노드이다.

### 가상 노드
가상 노드는 실제 서버 또는 노드를 가리키는 노드로서 하나의 서버는 링 위에 여러 개의 가상 노드를 가질 수 있다. 가상 노드의 개수를 늘리면 키의 분포는 점점 더 균등해지게 된다.(표준 편차가 작아져서 데이터가 고르게 분포되기 때문) 하지만 가상 노드의 개수를 무한정 늘리게 되면 가상 노드 데이터를 저장할 공간이 더 많이 필요하게 되고 결국엔 tradeoff가 존재하기 때문에 시스템 요구사항에 맞도록 가상 노드 개수를 적절히 조정해야 한다.

## 안정 해시의 이점
- 서버가 추가되거나 삭제될 때 재배치되는 키의 수가 최소화된다.
- 데이터가 보다 균등하게 분포하게 되므로 수평적 규모 확장성을 달성하기 쉽다.
- 핫스팟 키 문제를 줄인다. 즉, 데이터를 좀 더 균등하게 분배할 수 있다.

### 안정 해시가 사용되는 예제
- Amazon DynamoDB의 파티셔닝 관련 컴포넌트
- Apache Cassandra cluster에서의 data partitioning
- Discord의 채팅 app
- Akamai CDN
- Meglev 네트워크 부하 분산기